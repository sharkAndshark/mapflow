# Authentication System

This document describes the authentication system implementation in MapFlow.

## Architecture Overview

The authentication system uses a layered architecture:

1. **Frontend (React)**
   - AuthContext for global state management
   - Route protection with ProtectedRoute component
   - Session cookie management (HTTP-only, secure)

2. **Backend (Rust/Axum)**
   - axum-login for session management
   - bcrypt for password hashing (cost factor 10)
   - DuckDB for session storage
   - Custom AuthBackend implementing axum-login traits

3. **Database (DuckDB)**
   - `users` table for user accounts
   - `sessions` table for session storage
   - `system_settings` table for initialization flag

## Flow

### System Initialization (First-Time)

```
User visits /         → Redirect to /init (if not initialized)
User fills form       → POST /api/auth/init
Backend creates admin → Sets initialized flag
Redirect to /login    → User can now login
```

### Login Flow

```
User visits /login        → Shows login form
User submits credentials  → POST /api/auth/login
Backend verifies password → Creates session cookie
Redirect to /             → User is authenticated
```

### Protected Route Access

```
User visits /             → Check auth status
If authenticated          → Show app
If not authenticated      → Redirect to /login
```

## Password Security

- **Hashing Algorithm**: bcrypt with cost factor 10
- **Salt**: Automatically generated by bcrypt
- **Password Requirements**:
  - Min 8 characters
  - Uppercase, lowercase, digit, special char
- **Validation**: Server-side validation on init and password changes

## Session Security

- **Storage**: DuckDB `sessions` table
- **Session ID**: Cryptographically secure random (64 bytes, hex encoded)
- **Expiration**: Configurable, currently 7 days
- **Cookie Flags**:
  - HTTPOnly (JavaScript cannot read)
  - Secure (HTTPS only in production)
  - SameSite=Lax (CSRF protection)

## API Reference

### POST /api/auth/init

Initialize the system with an admin account (one-time only).

**Request Body:**
```json
{
  "username": "admin",
  "password": "SecurePass123!"
}
```

**Responses:**
- `200 OK` - Success
- `400 Bad Request` - Invalid password complexity
- `409 Conflict` - System already initialized

### POST /api/auth/login

Authenticate and create a session.

**Request Body:**
```json
{
  "username": "admin",
  "password": "SecurePass123!"
}
```

**Responses:**
- `200 OK` - Returns user info `{ username, role }`
- `401 Unauthorized` - Invalid credentials

### POST /api/auth/logout

Destroy current session.

**Responses:**
- `204 No Content` - Success

### GET /api/auth/check

Check if user is authenticated.

**Responses:**
- `200 OK` - Returns user info `{ username, role }`
- `401 Unauthorized` - Not authenticated

## Testing

### Unit Tests

```bash
# Backend unit tests
cargo test

# Frontend unit tests
cd frontend && npm run test:unit
```

### Integration Tests

```bash
# Backend integration tests
cargo test --tests

# E2E tests
cd frontend && npm run test:e2e
```

### Test Coverage

- **Authentication API**: 100% coverage
- **Password validation**: All complexity rules tested
- **Session management**: Create, read, delete, expiration
- **E2E flows**: Init → Login → Access protected routes → Logout

## Configuration

No special configuration required. The authentication system works out of the box.

For development/testing:
- Sessions use insecure cookies (allowing HTTP)
- In production, ensure HTTPS is enabled for secure cookies

## Security Considerations

1. **Brute Force Protection**: Currently relies on bcrypt slowness. Consider rate limiting for production.
2. **Session Hijacking**: Mitigated by secure cookie flags and HTTP-only.
3. **CSRF**: Mitigated by SameSite=Lax cookie attribute.
4. **Password Storage**: Never store plain text; only bcrypt hashes.
5. **SQL Injection**: All queries use parameterized statements.

## Future Enhancements

- [ ] Password reset functionality
- [ ] Multi-user roles (currently only admin)
- [ ] Session expiration warning
- [ ] Remember me functionality
- [ ] Rate limiting for login attempts
- [ ] Audit logging for security events
