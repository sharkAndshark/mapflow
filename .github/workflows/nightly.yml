name: nightly

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: nightly-release
  cancel-in-progress: false

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
      release_version: ${{ steps.meta.outputs.release_version }}
      stamp: ${{ steps.meta.outputs.stamp }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
      owner_lc: ${{ steps.meta.outputs.owner_lc }}
    steps:
      - id: meta
        shell: bash
        run: |
          set -euo pipefail
          stamp="$(date -u +'%Y%m%d')"
          short_sha="${GITHUB_SHA::7}"
          owner_lc="${GITHUB_REPOSITORY_OWNER,,}"
          release_tag="nightly-${stamp}-${short_sha}-r${GITHUB_RUN_NUMBER}"
          echo "stamp=${stamp}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"
          echo "owner_lc=${owner_lc}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "release_version=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "release_name=Nightly ${stamp} (${short_sha})" >> "$GITHUB_OUTPUT"

  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check spatial extension version sync
        run: bash scripts/ci/check_spatial_extension_version.sh

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: backend

      - name: Install protobuf compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Backend fmt (check)
        run: cargo fmt --manifest-path backend/Cargo.toml --all -- --check

      - name: Backend clippy
        run: cargo clippy --manifest-path backend/Cargo.toml -- -D warnings

      - name: Backend tests
        run: cargo test --manifest-path backend/Cargo.toml

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend install
        working-directory: frontend
        run: npm ci

      - name: Frontend unit tests
        working-directory: frontend
        run: npm run test:unit

      - name: Frontend format (check)
        working-directory: frontend
        run: npm run format:check

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps

      - name: Frontend E2E tests
        working-directory: frontend
        run: npm run test:e2e

  docker_smoke:
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - uses: actions/checkout@v6

      - name: Resolve spatial extension archive
        id: spatial
        shell: bash
        run: |
          set -euo pipefail
          url="$(bash scripts/release/spatial_extension_artifact.sh url linux_amd64)"
          echo "archive_url=${url}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (smoke)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          platforms: linux/amd64
          build-args: |
            SPATIAL_EXTENSION_ARCHIVE_URL=${{ steps.spatial.outputs.archive_url }}
          tags: mapflow-smoke:nightly

      - name: Smoke test container
        run: SMOKE_IMAGE="mapflow-smoke:nightly" bash scripts/ci/smoke_test.sh

  binaries:
    needs:
      - verify
      - meta
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
            artifact_id: linux-amd64
            duckdb_platform: linux_amd64
          - os: macos-14
            rust_target: aarch64-apple-darwin
            artifact_id: darwin-arm64
            duckdb_platform: osx_arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend install
        working-directory: frontend
        run: npm ci

      - name: Build frontend bundle
        working-directory: frontend
        run: npm run build

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          targets: ${{ matrix.rust_target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: backend

      - name: Install protobuf compiler (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protobuf compiler (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Build backend binary
        run: cargo build --release --locked --manifest-path backend/Cargo.toml --target ${{ matrix.rust_target }}

      - name: Package bundle
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          spatial_ext_path="release-assets/spatial.duckdb_extension"
          bash scripts/release/spatial_extension_artifact.sh download \
            "${{ matrix.duckdb_platform }}" \
            "${spatial_ext_path}"
          bash scripts/release/package_bundle.sh \
            "${{ needs.meta.outputs.release_version }}" \
            "${{ matrix.artifact_id }}" \
            "target/${{ matrix.rust_target }}/release/backend" \
            "${spatial_ext_path}" \
            "release-assets"

      - name: Upload binary bundle
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.artifact_id }}
          path: release-assets/*.tar.gz

  docker_build:
    needs:
      - docker_smoke
      - meta
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
            duckdb_platform: linux_amd64
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
            duckdb_platform: linux_arm64
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 75
    steps:
      - uses: actions/checkout@v6

      - name: Compute image name
        id: image
        shell: bash
        run: |
          owner_lc="${GITHUB_REPOSITORY_OWNER,,}"
          echo "name=ghcr.io/${owner_lc}/mapflow" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve spatial extension archive
        id: spatial
        shell: bash
        run: |
          set -euo pipefail
          url="$(bash scripts/release/spatial_extension_artifact.sh url "${{ matrix.duckdb_platform }}")"
          echo "archive_url=${url}" >> "$GITHUB_OUTPUT"

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          build-args: |
            SPATIAL_EXTENSION_ARCHIVE_URL=${{ steps.spatial.outputs.archive_url }}
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ github.workflow }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ matrix.arch }}

      - name: Export digest
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/digests
          echo "${{ steps.build.outputs.digest }}" > "/tmp/digests/${{ matrix.arch }}.txt"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: docker-digest-${{ matrix.arch }}
          path: /tmp/digests/${{ matrix.arch }}.txt

  docker_manifest:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - docker_build
      - meta
    steps:
      - name: Compute image name
        id: image
        shell: bash
        run: |
          owner_lc="${GITHUB_REPOSITORY_OWNER,,}"
          echo "name=ghcr.io/${owner_lc}/mapflow" >> "$GITHUB_OUTPUT"

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          pattern: docker-digest-*
          path: /tmp/digests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=raw,value=nightly
            type=raw,value=nightly-${{ needs.meta.outputs.stamp }}
            type=raw,value=nightly-${{ needs.meta.outputs.short_sha }}

      - name: Create multi-arch manifest
        shell: bash
        run: |
          set -euo pipefail
          image="${{ steps.image.outputs.name }}"

          sources=""
          for file in /tmp/digests/*/*.txt; do
            digest="$(cat "$file")"
            sources="${sources} ${image}@${digest}"
          done

          tags=""
          while IFS= read -r tag; do
            tags="${tags} --tag ${tag}"
          done <<< "${{ steps.meta.outputs.tags }}"

          docker buildx imagetools create ${tags} ${sources}

  github_release:
    runs-on: ubuntu-latest
    needs:
      - binaries
      - docker_manifest
      - meta
    steps:
      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: release-assets

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.release_tag }}
          name: ${{ needs.meta.outputs.release_name }}
          prerelease: true
          make_latest: false
          generate_release_notes: false
          body: |
            Nightly build from `${{ github.sha }}`.

            Docker images:
            - `ghcr.io/${{ needs.meta.outputs.owner_lc }}/mapflow:nightly`
            - `ghcr.io/${{ needs.meta.outputs.owner_lc }}/mapflow:nightly-${{ needs.meta.outputs.stamp }}`
            - `ghcr.io/${{ needs.meta.outputs.owner_lc }}/mapflow:nightly-${{ needs.meta.outputs.short_sha }}`
          fail_on_unmatched_files: true
          files: |
            release-assets/**/*.tar.gz
